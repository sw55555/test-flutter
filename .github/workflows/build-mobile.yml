name: Build App

on:
    workflow_call:
        inputs:
            ref:
                required: false
                type: string
            environment:
                description: 'Target environment'
                required: true
                default: 'development'
                type: string
        secrets:
            # KEY_JKS:
            #     required: true
            # ALIAS:
            #     required: true
            APP_STORE_CONNECT_API_KEY_ID:
                required: true
            APP_STORE_CONNECT_API_KEY_ISSUER_ID:
                required: true
            APP_STORE_CONNECT_API_KEY:
                required: true
            IOS_CERTIFICATE_P12:
                required: true
            IOS_CERTIFICATE_PASSWORD:
                required: true
            IOS_PROVISIONING_PROFILE:
                required: true
            IOS_DEVELOPMENT_PROVISIONING_PROFILE:
                required: true
            FASTLANE_TEAM_ID:
                required: true
    pull_request:
    push:
        branches: [main]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions: {}

jobs:
    build-sign-ios:
        name: Build and sign iOS
        # needs: pre-job
        permissions:
            contents: read
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v6 # v6
              with:
                  ref: ${{ inputs.ref || github.sha }}
                  persist-credentials: false

            - name: Setup Flutter SDK
              uses: subosito/flutter-action@v2 # v2
              with:
                  channel: stable
                  flutter-version-file: pubspec.yaml
                  cache: true

            - name: Install Flutter dependencies
              working-directory: .
              run: flutter pub get

            # - name: Generate translation files
            #   run: dart run easy_localization:generate -S ../i18n && dart run bin/generate_keys.dart
            #   working-directory: .

            # - name: Generate platform APIs
            #   run: make pigeon
            #   working-directory: .

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: '3.3'
                  bundler-cache: true
                  working-directory: ./ios

            # - name: Install CocoaPods dependencies
            #   working-directory: ./ios
            #   run: |
            #       pod install

            - name: Create API Key
              env:
                  API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
                  API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
                  API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
                  working-directory: ./ios
              run: |
                  mkdir -p ~/.appstoreconnect/private_keys
                  echo "$API_KEY_CONTENT" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8

            - name: Import Certificate and Provisioning Profiles
              env:
                  IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
                  IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
                  IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
                  IOS_DEVELOPMENT_PROVISIONING_PROFILE: ${{ secrets.IOS_DEVELOPMENT_PROVISIONING_PROFILE }}
                  ENVIRONMENT: ${{ inputs.environment || 'development' }}
              working-directory: ./ios
              run: |
                  # Decode certificate
                  echo "$IOS_CERTIFICATE_P12" | base64 --decode > certificate.p12

                  # Decode provisioning profiles based on environment
                  if [[ "$ENVIRONMENT" == "development" ]]; then
                      echo "$IOS_DEVELOPMENT_PROVISIONING_PROFILE" | base64 --decode > profile_dev.mobileprovision
                  else
                      echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
                  fi

                  ls -lh .

            - name: Create keychain and import certificate
              env:
                  KEYCHAIN_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
                  CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
              working-directory: ./ios
              run: |
                  # Create keychain
                  security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
                  security default-keychain -s build.keychain
                  security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
                  security set-keychain-settings -t 3600 -u build.keychain

                  # Import certificate
                  security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
                  security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

                  # Verify certificate was imported
                  security find-identity -v -p codesigning build.keychain

            - name: Build and deploy to TestFlight
              env:
                  FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
                  IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
                  KEYCHAIN_NAME: build.keychain
                  KEYCHAIN_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
                  APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
                  APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
                  ENVIRONMENT: ${{ inputs.environment || 'development' }}
                  BUNDLE_ID_SUFFIX: ${{ inputs.environment == 'production' && '' || 'development' }}
                  GITHUB_REF: ${{ github.ref }}
              working-directory: ./ios
              run: |
                  # Only upload to TestFlight on main branch
                  if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
                      if [[ "$ENVIRONMENT" == "development" ]]; then
                        bundle exec fastlane gha_testflight_dev
                      else
                        bundle exec fastlane gha_release_prod
                      fi
                  else
                      # Build only, no TestFlight upload for non-main branches
                      bundle exec fastlane gha_build_only
                  fi

            - name: Clean up keychain
              if: always()
              run: |
                  security delete-keychain build.keychain || true

            - name: Upload IPA artifact
              uses: actions/upload-artifact@v5 # v5.0.0
              with:
                  name: ios-release-ipa
                  path: ./ios/Runner.ipa
